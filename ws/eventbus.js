"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventBusConnection=void 0,require("core-js/modules/es.array-buffer.constructor.js"),require("core-js/modules/es.array-buffer.slice.js"),require("core-js/modules/es.promise.js"),require("core-js/modules/es.typed-array.uint8-array.js"),require("core-js/modules/es.typed-array.fill.js"),require("core-js/modules/es.typed-array.set.js"),require("core-js/modules/es.typed-array.sort.js"),require("core-js/modules/es.typed-array.to-locale-string.js"),require("core-js/modules/es.weak-map.js"),require("core-js/modules/esnext.aggregate-error.js"),require("core-js/modules/esnext.promise.any.js"),require("core-js/modules/web.dom-collections.iterator.js"),require("core-js/modules/web.url.js"),require("core-js/modules/web.url.to-json.js"),require("core-js/modules/web.url-search-params.js");var _config=require("../config.js"),_index=require("../utils/logger/index.js"),_exceptions=require("../types/exceptions.js"),_types=require("../types/types.js"),_proto=require("../types/proto.js"),_auth=require("../api/auth.js"),_observable_connection=require("./observable_connection.js");function _classPrivateMethodInitSpec(a,b){_checkPrivateRedeclaration(a,b),b.add(a)}function _classPrivateFieldInitSpec(a,b,c){_checkPrivateRedeclaration(a,b),b.set(a,c)}function _checkPrivateRedeclaration(a,b){if(b.has(a))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateFieldGet(b,c){return b.get(_assertClassBrand(b,c))}function _classPrivateFieldSet(b,c,a){return b.set(_assertClassBrand(b,c),a),a}function _assertClassBrand(a,b,c){if("function"==typeof a?a===b:a.has(b))return 3>arguments.length?b:c;throw new TypeError("Private element is not present on this object")}const ClientType=_proto.types.ClientType,BusMessage=_proto.cilix.BusMessage;let instance,clientType=ClientType.WEBAPP,clientName="client";const observable=new _observable_connection.Observable;var _expiryTimer=/*#__PURE__*/new WeakMap,_EventBusConnection_brand=/*#__PURE__*/new WeakSet;class EventBusConnection extends _observable_connection.ObservableRetryConnection{static getInstance(){return instance||(instance=new EventBusConnection),instance}static addEventListener(a){return observable.addEventListener(a)}static removeEventListener(a){observable.removeEventListener(a)}static setClientName(a){clientName=a}static setClientType(a){clientType=a}constructor(){super("eventbus-".concat(clientName)),_classPrivateMethodInitSpec(this,_EventBusConnection_brand),_classPrivateFieldInitSpec(this,_expiryTimer,void 0),this.observable=observable,this.userToken=null,_classPrivateFieldSet(_expiryTimer,this,null)}async stop(){clearTimeout(_classPrivateFieldGet(_expiryTimer,this)),super.stop()}async write(a){_index.logger.debug("".concat(this.name,".write: "),BusMessage.toObject(a));let b=BusMessage.encode(a).finish();return super.write(b)}writeObject(a){let b=BusMessage.verify(a);if(b)throw new Error(b);let c=BusMessage.fromObject(a);return this.write(c)}async getURI(){try{this.userToken=await(0,_auth.getUserToken)(),this.userClaims=new _types.UserClaims(this.userToken);let a=this.userClaims.getSecondsUntilExpiry();if(0>=a){let a=new _exceptions.PermissionDeniedError("user token expired");throw this.onError(a),a}_classPrivateFieldSet(_expiryTimer,this,setTimeout(()=>{this.onError(new _exceptions.SessionTimeoutError("user token expired"))},a))}catch(a){let b=new _exceptions.PermissionDeniedError(a);throw this.onError(b),b}let a=new URL(_config.Config.apiBaseURL),b=a.host+("/"===a.pathname?"":a.pathname),c=_assertClassBrand(_EventBusConnection_brand,this,_getClientTypeAsString).call(this,clientType);return"wss://".concat(b,"/ws/eventbus/").concat(c,"?user_token=").concat(this.userToken,"&name=").concat(clientName)}onData(a){try{if(a instanceof ArrayBuffer){let b=new Uint8Array(a),c=BusMessage.decode(b);return b=null,_index.logger.debug("".concat(this.name,".read: "),c),void _assertClassBrand(_EventBusConnection_brand,this,_onMessage).call(this,c)}}catch(a){_index.logger.error(a)}this.parseJSONResponse(a)}stopStream(a){return this.writeObject({stopRequest:{},dst:{id:a}})}stopAllStreams(){return this.writeObject({stopRequest:{}})}startStream(a){let{config:b,runtimeConfig:c,camera:d,clientId:e,meetingToken:f}=a;return this.writeObject({startRequest:{config:b,runtimeConfig:c,camera:d,meetingToken:f},dst:{id:e}})}requestCameraPreview(a,b){return this.writeObject({previewRequest:{source:{id:b}},dst:{id:a}})}setRuntimeConfig(a,b){return this.writeObject({runtimeConfigRequest:b,dst:{id:a}})}getCameraList(a){return this.writeObject({cameraListRequest:{},dst:{id:a}})}sendCameraList(a,b,c){return this.writeObject({cameraListResponse:{items:a},src:b,dst:c})}getClientStatusList(){return this.writeObject({clientStatusRequest:{}})}}exports.EventBusConnection=EventBusConnection;async function _onMessage(a){if(a&&"object"==typeof a)try{a.clientConnected&&_assertClassBrand(_EventBusConnection_brand,this,_onClientConnected).call(this,a),a.clientDisconnected&&_assertClassBrand(_EventBusConnection_brand,this,_onClientDisconnected).call(this,a),a.cameraListRequest&&_assertClassBrand(_EventBusConnection_brand,this,_onCameraListRequest).call(this,a),a.cameraListResponse&&_assertClassBrand(_EventBusConnection_brand,this,_onCameraListResponse).call(this,a),a.runtimeConfigRequest&&_assertClassBrand(_EventBusConnection_brand,this,_onRuntimeConfigRequest).call(this,a),a.startRequest&&_assertClassBrand(_EventBusConnection_brand,this,_onStartRequest).call(this,a),a.stopRequest&&_assertClassBrand(_EventBusConnection_brand,this,_onStopRequest).call(this,a),a.previewRequest&&_assertClassBrand(_EventBusConnection_brand,this,_onPreviewRequest).call(this,a),a.previewResponse&&_assertClassBrand(_EventBusConnection_brand,this,_onPreviewResponse).call(this,a),a.ipsaResponse&&_assertClassBrand(_EventBusConnection_brand,this,_onIPSAResponse).call(this,a),a.tooManyPublishers&&_assertClassBrand(_EventBusConnection_brand,this,_onTooManyPublishers).call(this,a),a.recordingStarted&&_assertClassBrand(_EventBusConnection_brand,this,_onRecordingStarted).call(this,a),a.recordingStopped&&_assertClassBrand(_EventBusConnection_brand,this,_onRecordingStopped).call(this,a)}catch(a){_index.logger.error(a)}}function _getClientTypeAsString(a){let b=Object.entries(ClientType).find(b=>{let[c,d]=b;return d==a});if(!b)throw new _exceptions.InvalidArgumentError("Invalid client type: ".concat(a));let c=b[0].toLowerCase();return c}function _sendPreview(a,b){this.writeObject({previewResponse:{image:a},dst:b})}async function _onCameraListRequest(a){let b=await _assertClassBrand(_EventBusConnection_brand,this,_callSubscribers).call(this,"onCameraListRequest",a.cameraListRequest);this.sendCameraList(b,a.dst,a.src)}function _onCameraListResponse(a){observable.notify("onCameraListResponse",a.cameraListResponse)}function _onClientConnected(a){_index.logger.info("".concat(this.name,": client connected: "),a.src),observable.notify("onClientConnected",a.src)}function _onClientDisconnected(a){_index.logger.warn("".concat(this.name,": client disconnected: "),a.src),observable.notify("onClientDisconnected",a.src)}function _onRuntimeConfigRequest(a){observable.notify("onRuntimeConfigRequest",a.runtimeConfigRequest)}function _onStopRequest(a){observable.notify("onStopRequest",a.stopRequest)}async function _onPreviewRequest(a){let b=await _assertClassBrand(_EventBusConnection_brand,this,_callSubscribers).call(this,"onPreviewRequest",a.previewRequest);_assertClassBrand(_EventBusConnection_brand,this,_sendPreview).call(this,b,a.src)}function _onPreviewResponse(a){observable.notify("onPreviewResponse",a.previewResponse)}function _onStartRequest(a){var b,c;let d=a.startRequest;!(null!==d&&void 0!==d&&null!==(b=d.camera)&&void 0!==b&&b.id)&&null!==d&&void 0!==d&&null!==(c=d.inputSource)&&void 0!==c&&c.id&&(d.camera={id:d.inputSource.id}),observable.notify("onStartRequest",d)}function _onCornersReceived(a){observable.notify("onCornersReceived",a.corners.corners)}function _onIPSAResponse(a){a&&observable.notify("onIPSAResponse",a.ipsaResponse)}function _onTooManyPublishers(a){observable.notify("onTooManyPublishers",a.tooManyPublishers)}function _onRecordingStarted(a){observable.notify("onRecordingStarted",a.recordingStarted)}function _onRecordingStopped(a){observable.notify("onRecordingStopped",a.recordingStopped)}function _callSubscribers(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];let e=[...observable.observers].map(b=>{let[c,d]=b;return d[a]}).filter(a=>a!==void 0).map(a=>a(...c));return Promise.any(e)}